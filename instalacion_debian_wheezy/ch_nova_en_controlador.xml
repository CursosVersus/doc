<?xml version="1.0" encoding="utf-8"?>
<chapter xmlns="http://docbook.org/ns/docbook"
	 xmlns:xlink="http://www.w3.org/1999/xlink"
	  xmlns:xi="http://www.w3.org/2001/XInclude"
	 version="5.0" xml:lang="es">
  <title>Nova en el nodo controlador</title>
  <para>Este capítulo describe la instalación y configuración del
  módulo nova de OpenStack. Este módulo es el encargado de gestionar
  las instancias del cloud y por tanto es el elemento central para un
  cloud de infraestructura como el nuestro.</para>
  <section xml:id="introduccion_nova">
    <title>Introducción al módulo nova</title>
    <para>Se explica posteriormente.</para>
  </section>
  
  <section xml:id="instalación_nova">
    <title>Instalación</title>
    <para>Instalamos desde el repositorio de Debian:</para>
    <screen>
      <prompt>#</prompt><userinput>aptitude install nova-api nova-scheduler nova-cert nova-console</userinput>
    </screen> 
    <para>Durante la configuración de los paquetes se nos pregunta si queremos
    configurar la base de datos con <command>dbconfig-common</command>, a lo que
    respondemos que no, posteriormente configuraremos la base de datos
    directamente sobre los ficheros de configuración de nova.</para>
    <para>Además de los paquetes del repositorio Debian anteriormente
    indicado, debemos instalar los siguientes paquetes, cuyas
    versiones actuales que se encuentran en el repositorio testing de
    Debian no funcionan correctamente. Además se debe activar la
    propiedad "hold" para que estos paquetes no se actualicen en
    futuras actualizaciones:</para>
     <para><prompt>#</prompt><userinput>dpkg -i
     novnc_2012.1~e3+dfsg-1_amd64.deb
     dpkg -i python-novnc_2012.1~e3+dfsg-1_all.deb
     echo novnc hold |  dpkg --set-selections
     echo python-novnc hold |  dpkg --set-selections
   </userinput></para>

  </section>
  <section xml:id="configuración_nova">
    <title>Configuración</title>
    <para>Veamos la configuración necesaria para que funcione
    adecuadamente el componente nova:</para>
    <para><filename>/etc/nova/nova.conf</filename></para>
    <programlisting>
      <xi:include href="nova.conf.controlador"  parse="text"/> 
    </programlisting>
    <para><filename>/etc/nova/api-paste.ini</filename></para>
    <para>En este fichero se añaden las mismas líneas que ne la
    configuración de glance, donde se indica el usuario, la contraseña y
    el tenant con el que nos vamos a autentificar.</para>
    <programlisting>
admin_tenant_name = service
admin_user = "usuario jefe"
admin_password = "password de usuario jefe"
    </programlisting>
  <para>Para finalizar el proceso de configuración y después de
  habernos autentificado, debemos crear la tablas necesarias en la
  base de datos, para ello ejecutamos el siguiente comando:</para>
  <programlisting>jupiter:~#nova-manage db sync</programlisting>
  <para>Veamos detalladamente cada una de los grupos de
  directivas:</para>
  <section xml:id="conf_nova_1">
   <title>Configuración de los logs</title>
   <para></para>
  </section>
  <section xml:id="conf_nova_2">
   <title>Configuración del hypervisor</title>
   <para></para>
  </section>
  <section xml:id="conf_nova_3">
   <title>Configuración de la autentificación y la autorización</title>
   <para></para>
  </section>
  <section xml:id="conf_nova_4">
   <title>Configuración de la base de datos</title>
   <para></para>
  </section>
  <section xml:id="conf_nova_5">
   <title>Configuración del servicio de imágenes (glance)</title>
   <para></para>
  </section>
  <section xml:id="conf_nova_6">
   <title>Configuración de las migraciones en vivo</title>
   <para></para>
  </section>
  <section xml:id="conf_nova_7">
   <title>Configuración del sistema de mensajería interna
   (RabbitMQ)</title>
   <para></para>
   </section>
   <section xml:id="conf_nova_8">
   <title>Configuración del esquema de red</title>
   <para></para>
  </section>
  </section>
  <section xml:id="configuracion_red_nova">
    <title>Tipos de configuración de red</title>
    <para>Como hemos vistos en puntos anteriores, los usuarios
    organizan sus recursos en el cloud en proyectos. Un royecto es un
    conjunto de instancias o máquinas virtuales creadas por el
    usuario. A cada instancia se le asigna una ip privada.</para>
    <para>Actualmente podemos configurar la red de nuestra nube de
    tres formas distintas:</para>
    <itemizedlist>
     <listitem><para>Flat Network Manager</para></listitem>
     <listitem><para>Flat DHCP Network Manager</para></listitem>
     <listitem><para>VLAN Network Mananger</para></listitem>
    </itemizedlist>
    <para>Tenemos que señalar la diferencia entre ip fija o privada,
    que es la dirección que se le asigna a la instancia desde su
    creación hasta su destrucción, y las ip flotantes, que son
    direcciones que dinámicamente se pueden asignar a una instancia y
    que nos va a permitir acceder a ellas desde una red
    pública.</para>
    <para>En los dos primeros modos de red (Flat Mode) el administrador
    debe indicar un conjunto de direcciones que serán asignadas como
    ip fijas o privadas cuando se creen las instancias. La diferencia
    entre los dos modos es, que mientras en el primero la ip se
    intecta en la configuración de la máquina (es decir se escribe en
    el fichero /etc/network/interfaces), en la segunda opción exite un
    servidor DHCP que es el responsable de asignar las ip a las
    distintas instancias.</para>
    <para>En el modo VLAN, se crea una vlan y un bridge para cada
    proyecto (tenant), de esta manera conseguimos que las máquinas
    virtuales pertenecientes a un proyecto reciban direcciones
    privadas de un rango que será sólo accesible desde la propia
    vlan, se decir cada proyecto está relacionado con vlan, con lo que
    conseguimos aislar las instancias de los diferentes
    proyectos. Esta características es lo que nos ha decidido a
    escoger este modo de red para nuestra infraestructura.</para>
    <section xml:id="configuracion_vlan">
      <title>Configuración del tipo de red VLAN</title>
      <para>Los requisitos para utilizar el modo VLAN como
      configuración de red son los siguientes:</para>
      <itemizedlist>
	<listitem><para>El ip forwading debe estar
	habilitado.</para></listitem>
	<listitem><para>Los nodos de computación (que tienen instalado
	nova-network y nova-compute) tienen que tener cargado el
	módulo del kernel 8021q.</para></listitem>
	<listitem><para>Los switches de la red deben soportar la
	configuración de vlan.</para></listitem>
	<listitem><para>Los switches de de la red deben estar
	configurados con las mismas vlan que hayamos
	creado.</para></listitem>
      </itemizedlist>
      <para>Para configurar este modo de red tenemos que añadir al
      fichero de configuración
      <filename>/etc/nova/nova.conf</filename>:</para>
      <programlisting>
	network_manager=nova.network.manager.VlanManager
	vlan_interface=eth1
	fixed_range=10.0.0.0/8
	network_size=256
      </programlisting>
    <para>En la primera línea se especifica que vamos a usar el modo
    de red VLAN. Con la directiva <command>vlan_interface</command>
    indicamos la interfaz de red con la que se va asociar el bridge
    que se ha creado. La directiva <command>fixed_range</command>
    indica el rango completo de ip que se va a dividir en subredes
    para cada vlan creada. Por último, la directiva
    <command>network_size</command> indica el tmaña de cada subred
    asociada a cada vlan. </para>
    </section>
    <section xml:id="creacion_vlan">
      <title>Creación de un VLAN</title>
      <para>Como cada proyecto (tenant) se asocia a una vlan, debemos
      crear el número de vlan suficientes para los proyectos que en el
      futuro vayamos a crear. Ahora mismo, vamos a crear una sola vlan
      que se asociará a un sólo proyecto, para ello usamos el comando
      <command>nova-manage network create</command>:</para>
      <programlisting>
	nova-manage network create --label=vlan1
	--fixed_range_v4=10.0.1.0/24 --vlan=1 --bridge=br1 
      </programlisting>
      <para>Con este comando hemos creado la vlan1 que tendrá la
      etiqueta vlan "1" y que posee como rango de ip la
      10.0.1.0/24. Todas las instancias que usen esta vlan estarán
      conectadas al bridge br1.</para>
      <para>Cuando creemos una instancia de un proyecto, dicho
      proyecto se asocia a una vlan que este libre, a partir de
      entonces todas las instancias de ese proyecto utilizarán la
      misma vlan.</para>
      </section>
      <section xml:id="creacion_ip_flotante">
	<title>Creación de un rango de ip flotantes (ip
	públicas)</title>
	<para>Como indicábamos anteriormente a las instancias se le
	puede asignar dinámicamente una ip pública o flotante que nos
	permite el acceso a ella desde la red pública. En esta sección
	vamos a indicar como se crea el rango de ip flotantes.</para>
	<para> Nosotros vamos a crear un rango de ip flotante con el
	siguiente <command> nova-manage floating create</command> de
	la siguiente manera:</para>
	<programlisting>
	   nova-manage floating create --ip_range=172.22.221.0/24
	</programlisting>
	<para> Posteriormente estudiaremos la utilización de estas ips
	en las distintas instancias.</para>
      </section>
    </section>
   

</chapter>

    
